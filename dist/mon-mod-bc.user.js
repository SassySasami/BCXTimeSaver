// ==UserScript==
// @name         MonModBC
// @namespace    https://github.com/SassySasami/BCXTimeSaver
// @version      0.1.1
// @description  Exemple de mod BC utilisant le Mod SDK
// @author       Sassy
// @match https://*.bondageprojects.elementfx.com/R*/*
// @match https://*.bondage-europe.com/R*/*
// @match https://*.bondageprojects.com/R*/*
// @match https://*.bondage-asia.com/Club/R*
// @match http://localhost:*/*
// @grant        none
// @run-at       document-start
// @updateURL    https://raw.githubusercontent.com/SassySasami/BCXTimeSaver/main/dist/mon-mod-bc.user.js
// @downloadURL  https://raw.githubusercontent.com/SassySasami/BCXTimeSaver/main/dist/mon-mod-bc.user.js
// ==/UserScript==
!function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t,n={};var o,a=(t||(t=1,o=n,function(){const e="1.2.0";function t(e){alert("Mod ERROR:\n"+e);const t=new Error(e);throw console.error(t),t}const n=new TextEncoder;function a(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function r(e){const t=new Set;return e.filter(e=>!t.has(e)&&t.add(e))}const i=new Map,c=new Set;function d(e){c.has(e)||(c.add(e),console.warn(e))}function s(e){const t=[],n=new Map,o=new Set;for(const a of m.values()){const r=a.patching.get(e.name);if(r){t.push(...r.hooks);for(const[t,i]of r.patches.entries())n.has(t)&&n.get(t)!==i&&d(`ModSDK: Mod '${a.name}' is patching function ${e.name} with same pattern that is already applied by different mod, but with different pattern:\nPattern:\n${t}\nPatch1:\n${n.get(t)||""}\nPatch2:\n${i}`),n.set(t,i),o.add(a.name)}}t.sort((e,t)=>t.priority-e.priority);const a=function(e,t){if(0===t.size)return e;let n=e.toString().replaceAll("\r\n","\n");for(const[o,a]of t.entries())n.includes(o)||d(`ModSDK: Patching ${e.name}: Patch ${o} not applied`),n=n.replaceAll(o,a);return(0,eval)(`(${n})`)}(e.original,n);let r=function(t){var n,r;const i=null===(r=(n=h.errorReporterHooks).hookChainExit)||void 0===r?void 0:r.call(n,e.name,o),c=a.apply(this,t);return null==i||i(),c};for(let n=t.length-1;n>=0;n--){const o=t[n],a=r;r=function(t){var n,r;const i=null===(r=(n=h.errorReporterHooks).hookEnter)||void 0===r?void 0:r.call(n,e.name,o.mod),c=o.hook.apply(this,[t,e=>{if(1!==arguments.length||!Array.isArray(t))throw new Error(`Mod ${o.mod} failed to call next hook: Expected args to be array, got ${typeof e}`);return a.call(this,e)}]);return null==i||i(),c}}return{hooks:t,patches:n,patchesSources:o,enter:r,final:a}}function l(e,t=!1){let o=i.get(e);if(o)t&&(o.precomputed=s(o));else{let t=window;const r=e.split(".");for(let n=0;n<r.length-1;n++)if(t=t[r[n]],!a(t))throw new Error(`ModSDK: Function ${e} to be patched not found; ${r.slice(0,n+1).join(".")} is not object`);const c=t[r[r.length-1]];if("function"!=typeof c)throw new Error(`ModSDK: Function ${e} to be patched not found`);const d=function(e){let t=-1;for(const o of n.encode(e)){let e=255&(t^o);for(let t=0;t<8;t++)e=1&e?-306674912^e>>>1:e>>>1;t=t>>>8^e}return((-1^t)>>>0).toString(16).padStart(8,"0").toUpperCase()}(c.toString().replaceAll("\r\n","\n")),l={name:e,original:c,originalHash:d};o=Object.assign(Object.assign({},l),{precomputed:s(l),router:()=>{},context:t,contextProperty:r[r.length-1]}),o.router=function(e){return function(...t){return e.precomputed.enter.apply(this,[t])}}(o),i.set(e,o),t[o.contextProperty]=o.router}return o}function p(){for(const e of i.values())e.precomputed=s(e)}function u(){const e=new Map;for(const[t,n]of i)e.set(t,{name:t,original:n.original,originalHash:n.originalHash,sdkEntrypoint:n.router,currentEntrypoint:n.context[n.contextProperty],hookedByMods:r(n.precomputed.hooks.map(e=>e.mod)),patchedByMods:Array.from(n.precomputed.patchesSources)});return e}const m=new Map;function f(e){m.get(e.name)!==e&&t(`Failed to unload mod '${e.name}': Not registered`),m.delete(e.name),e.loaded=!1,p()}function b(e,n){e&&"object"==typeof e||t("Failed to register mod: Expected info object, got "+typeof e),"string"==typeof e.name&&e.name||t("Failed to register mod: Expected name to be non-empty string, got "+typeof e.name);let o=`'${e.name}'`;"string"==typeof e.fullName&&e.fullName||t(`Failed to register mod ${o}: Expected fullName to be non-empty string, got ${typeof e.fullName}`),o=`'${e.fullName} (${e.name})'`,"string"!=typeof e.version&&t(`Failed to register mod ${o}: Expected version to be string, got ${typeof e.version}`),e.repository||(e.repository=void 0),void 0!==e.repository&&"string"!=typeof e.repository&&t(`Failed to register mod ${o}: Expected repository to be undefined or string, got ${typeof e.version}`),null==n&&(n={}),n&&"object"==typeof n||t(`Failed to register mod ${o}: Expected options to be undefined or object, got ${typeof n}`);const r=!0===n.allowReplace,i=m.get(e.name);i&&(i.allowReplace&&r||t(`Refusing to load mod ${o}: it is already loaded and doesn't allow being replaced.\nWas the mod loaded multiple times?`),f(i));const c=e=>{let t=u.patching.get(e.name);return t||(t={hooks:[],patches:new Map},u.patching.set(e.name,t)),t},d=(e,n)=>(...a)=>{var r,i;const c=null===(i=(r=h.errorReporterHooks).apiEndpointEnter)||void 0===i?void 0:i.call(r,e,u.name);u.loaded||t(`Mod ${o} attempted to call SDK function after being unloaded`);const d=n(...a);return null==c||c(),d},s={unload:d("unload",()=>f(u)),hookFunction:d("hookFunction",(e,n,a)=>{"string"==typeof e&&e||t(`Mod ${o} failed to patch a function: Expected function name string, got ${typeof e}`);const r=l(e),i=c(r);"number"!=typeof n&&t(`Mod ${o} failed to hook function '${e}': Expected priority number, got ${typeof n}`),"function"!=typeof a&&t(`Mod ${o} failed to hook function '${e}': Expected hook function, got ${typeof a}`);const d={mod:u.name,priority:n,hook:a};return i.hooks.push(d),p(),()=>{const e=i.hooks.indexOf(d);e>=0&&(i.hooks.splice(e,1),p())}}),patchFunction:d("patchFunction",(e,n)=>{"string"==typeof e&&e||t(`Mod ${o} failed to patch a function: Expected function name string, got ${typeof e}`);const r=l(e),i=c(r);a(n)||t(`Mod ${o} failed to patch function '${e}': Expected patches object, got ${typeof n}`);for(const[a,r]of Object.entries(n))"string"==typeof r?i.patches.set(a,r):null===r?i.patches.delete(a):t(`Mod ${o} failed to patch function '${e}': Invalid format of patch '${a}'`);p()}),removePatches:d("removePatches",e=>{"string"==typeof e&&e||t(`Mod ${o} failed to patch a function: Expected function name string, got ${typeof e}`);const n=l(e);c(n).patches.clear(),p()}),callOriginal:d("callOriginal",(e,n,a)=>{"string"==typeof e&&e||t(`Mod ${o} failed to call a function: Expected function name string, got ${typeof e}`);const r=l(e);return Array.isArray(n)||t(`Mod ${o} failed to call a function: Expected args array, got ${typeof n}`),r.original.apply(null!=a?a:globalThis,n)}),getOriginalHash:d("getOriginalHash",e=>("string"==typeof e&&e||t(`Mod ${o} failed to get hash: Expected function name string, got ${typeof e}`),l(e).originalHash))},u={name:e.name,fullName:e.fullName,version:e.version,repository:e.repository,allowReplace:r,api:s,loaded:!0,patching:new Map};return m.set(e.name,u),Object.freeze(s)}function g(){const e=[];for(const t of m.values())e.push({name:t.name,fullName:t.fullName,version:t.version,repository:t.repository});return e}let h;const y=void 0===window.bcModSdk?window.bcModSdk=function(){const t={version:e,apiVersion:1,registerMod:b,getModsInfo:g,getPatchingInfo:u,errorReporterHooks:Object.seal({apiEndpointEnter:null,hookEnter:null,hookChainExit:null})};return h=t,Object.freeze(t)}():(a(window.bcModSdk)||t("Failed to init Mod SDK: Name already in use"),1!==window.bcModSdk.apiVersion&&t(`Failed to init Mod SDK: Different version already loaded ('1.2.0' vs '${window.bcModSdk.version}')`),window.bcModSdk.version!==e&&alert(`Mod SDK warning: Loading different but compatible versions ('1.2.0' vs '${window.bcModSdk.version}')\nOne of mods you are using is using an old version of SDK. It will work for now but please inform author to update`),window.bcModSdk);Object.defineProperty(o,"__esModule",{value:!0}),o.default=y}()),n),r=e(a);!function(){try{const e=r.registerMod({name:"MonModBC",fullName:"Mon Mod Bondage Club",version:"0.2.1",repository:"https://github.com/SassySasami/BCTest"});console.log("[MonModBC] Mod chargé via SDK-1",e)}catch(e){console.warn("[MonModBC] SDK indisponible (non bloquant):",e)}const e="MonModBC.rules",t="MonModBC.rules.title",n="Règles BCX",o=["Respect et consentement obligatoires. Pas de harcèlement.","Pas de contenu NSFW explicite dans le chat public.","Aucune triche, exploit ou outil perturbateur.","Restez dans le thème RP si la salle l’indique.","Langage correct, pas d’insultes ni de propos discriminants.","Suivez les instructions des modérateurs/organisateurs.","Pas de spam, flood ou publicité non autorisée."].join("\n");let a=!0,i=[],c=null,d=null;function s(e,t){try{const n=localStorage.getItem(e);return null==n?t:n}catch{return t}}function l(e,t){try{localStorage.setItem(e,t)}catch{}}function p(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e]??e)}function u(e,t=1400){let n=document.getElementById("mmdbc-toast");n||(n=document.createElement("div"),n.id="mmdbc-toast",n.className="mmdbc-toast",document.body.appendChild(n)),n.textContent=e,n.style.opacity="1",n.style.transform="translate(-50%, 0)",window.setTimeout(()=>{n.style.opacity="0",n.style.transform="translate(-50%, 20px)"},t)}function m(){if(document.getElementById("monmodbc-panel"))return;!function(){if(document.getElementById("monmodbc-style"))return;const e=document.createElement("style");e.id="monmodbc-style",e.textContent="\n      #monmodbc-panel {\n        position: fixed; top: 80px; right: 20px; z-index: 2147483647;\n        background: rgba(20,20,28,0.96); color: #fff;\n        font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;\n        border: 1px solid #3a3a4a; border-radius: 10px;\n        box-shadow: 0 10px 30px rgba(0,0,0,0.35);\n        width: 360px; user-select: none; display: none;\n      }\n      #monmodbc-panel header {\n        display: flex; align-items: center; gap: 8px; justify-content: space-between;\n        padding: 10px 12px; background: #2a2a3a; border-radius: 10px 10px 0 0; cursor: move;\n      }\n      #monmodbc-title-input {\n        flex: 1 1 auto; max-width: 100%; min-width: 0;\n        background: transparent; border: none; color: #fff; font-weight: 600; outline: none;\n      }\n      #monmodbc-close {\n        width: 22px; height: 22px; border-radius: 6px; border: 1px solid #555; background: #3a3a4a; color: #fff;\n      }\n      #monmodbc-body { display: flex; flex-direction: column; gap: 10px; padding: 10px 12px; }\n      #monmodbc-text { width: 100%; height: 140px; resize: vertical; background: #11131a; color: #fff;\n        border: 1px solid #3a3a4a; border-radius: 8px; padding: 8px; }\n      .mmdbc-row { display: flex; gap: 8px; align-items: center; }\n      .mmdbc-row.right { justify-content: flex-end; }\n      .mmdbc-btn {\n        background: #3a3a4a; color: #fff; border: 1px solid #555; border-radius: 8px; padding: 6px 10px; cursor: pointer;\n      }\n      .mmdbc-select, .mmdbc-input {\n        background: #11131a; color: #fff; border: 1px solid #3a3a4a; border-radius: 8px; padding: 6px 8px;\n      }\n      #mmdbc-rules { max-height: 200px; overflow: auto; border: 1px solid #3a3a4a; border-radius: 8px; padding: 6px; background: #0d0f15; }\n      .mmdbc-rule { display: flex; align-items: center; gap: 8px; padding: 4px 2px; }\n      .mmdbc-rule .name { font-weight: 600; }\n      .mmdbc-rule .desc { opacity: .8; font-size: 12px; }\n      .mmdbc-status { font-size: 12px; opacity: .9; }\n      #monmodbc-mini {\n        position: fixed; top: 80px; right: 20px; z-index: 2147483647;\n        background: #2a2a3a; color: #fff; border: 1px solid #555; border-radius: 999px; padding: 8px 10px; cursor: pointer;\n        display: none;\n      }\n      .mmdbc-toast {\n        position: fixed; bottom: 18px; left: 50%; transform: translate(-50%, 20px);\n        background: #111; color: #fff; padding: 10px 14px; border-radius: 10px; opacity: 0;\n        transition: opacity .2s ease, transform .2s ease; z-index: 2147483647;\n      }\n      .mmdbc-switch { position: relative; width: 38px; height: 20px; display: inline-block; }\n      .mmdbc-switch input { display: none; }\n      .mmdbc-slider {\n        position: absolute; inset: 0; background: #444; border-radius: 20px; transition: .2s;\n      }\n      .mmdbc-slider:before {\n        content: ''; position: absolute; width: 16px; height: 16px; left: 2px; top: 2px;\n        background: #fff; border-radius: 50%; transition: .2s;\n      }\n      input:checked + .mmdbc-slider { background: #4f46e5; }\n      input:checked + .mmdbc-slider:before { transform: translateX(18px); }\n    ",document.head.appendChild(e)}();const r=document.createElement("button");r.id="monmodbc-mini",r.textContent="Règles",document.body.appendChild(r);const m=document.createElement("div");m.id="monmodbc-panel",m.style.display=a?"block":"none",document.body.appendChild(m);const f=document.createElement("header"),b=document.createElement("input");b.id="monmodbc-title-input",b.type="text",b.value=s(t,n);const g=document.createElement("button");g.id="monmodbc-close",g.className="mmdbc-btn",g.textContent="–",f.appendChild(b),f.appendChild(g),m.appendChild(f);const h=document.createElement("div");h.id="monmodbc-body",m.appendChild(h);const y=document.createElement("textarea");y.id="monmodbc-text",y.value=s(e,o),h.appendChild(y);const x=document.createElement("div");x.className="mmdbc-row right";const w=document.createElement("button");w.className="mmdbc-btn",w.textContent="Enregistrer";const v=document.createElement("button");v.className="mmdbc-btn",v.textContent="Copier";const E=document.createElement("button");E.className="mmdbc-btn",E.textContent="Réinitialiser",x.append(w,v,E),h.appendChild(x);const M=document.createElement("div");M.className="mmdbc-row";const C=document.createElement("select");C.className="mmdbc-select",C.style.flex="1 1 auto";const k=document.createElement("button");k.className="mmdbc-btn",k.textContent="Actualiser";const $=document.createElement("button");$.className="mmdbc-btn",$.textContent="Importer depuis ce sub",M.append(C,k,$),h.appendChild(M);const S=document.createElement("div");S.className="mmdbc-row";const N=document.createElement("input");N.className="mmdbc-input",N.placeholder="Rechercher une règle...",N.style.flex="1 1 auto",S.appendChild(N),h.appendChild(S);const R=document.createElement("div");R.id="mmdbc-rules",h.appendChild(R);const B=document.createElement("div");B.className="mmdbc-row";const L=document.createElement("span");function A(){m.style.display=a?"block":"none",r.style.display=a?"none":"block"}function P(e){C.disabled=e,k.disabled=e,$.disabled=e,N.disabled=e}function j(e,t="#ccc"){L.textContent=e,L.style.color=t}function F(e,t){R.innerHTML="";const n=t.trim().toLowerCase(),o=n?e.filter(e=>e.name.toLowerCase().includes(n)||(e.description??"").toLowerCase().includes(n)||(e.tags??[]).some(e=>e.toLowerCase().includes(n))):e;if(0===o.length){const e=document.createElement("div");return e.style.opacity="0.7",e.textContent=n?"Aucune règle ne correspond.":"Aucune règle à afficher.",void R.appendChild(e)}for(const e of o){const t=document.createElement("div");t.className="mmdbc-rule";const n=document.createElement("label");n.className="mmdbc-switch";const o=document.createElement("input");o.type="checkbox",o.checked=!!e.enabled;const a=document.createElement("span");a.className="mmdbc-slider",n.append(o,a);const r=document.createElement("div"),i=document.createElement("div");i.className="name",i.textContent=e.name||e.id;const d=document.createElement("div");d.className="desc",d.innerHTML=p(e.description??""),r.append(i,d),t.append(n,r),R.appendChild(t),o.addEventListener("change",async()=>{if(c){P(!0);try{const t=c.setEnabled??c.setRuleEnabled??c.enableRule;if("function"!=typeof t)throw new Error("Méthode setEnabled absente");await Promise.resolve(t.call(c,e.id,o.checked)),e.enabled=o.checked,j(`Règle ${e.name} ${o.checked?"activée":"désactivée"}.`,"#9fe89f")}catch(e){console.warn("[MonModBC] setEnabled a échoué",e),o.checked=!o.checked,j("Impossible de changer cette règle (droits ?).","#f2a3a3")}finally{P(!1)}}else o.checked=!o.checked})}}async function O(){C.innerHTML="";const e=document.createElement("option");e.value="",e.textContent=c?"Choisir un sub...":"BCX non détecté",C.appendChild(e);const t=[];try{const e=d?.listSubs?.()??d?.getSubs?.()??[],n=Array.isArray(e)?e:await Promise.resolve(e);for(const e of n){if(!e)continue;const n=String(e.id??e.ID??e.name??""),o=String(e.name??e.id??e.ID??"");n&&t.push({id:n,name:o})}}catch(e){console.warn("[MonModBC] Récupération subs a échoué",e)}for(const e of t){const t=document.createElement("option");t.value=e.id,t.textContent=e.name||e.id,C.appendChild(t)}j(c?`BCX OK — ${t.length} sub(s) détecté(s).`:"BCX non détecté.",c?"#9fe89f":"#f2a3a3")}async function D(){if(!c)return i=[],void F(i,N.value);P(!0);try{const e=c.listRules??c.getAll??c.getRules;if("function"!=typeof e)throw new Error("Méthode listRules absente");const t=await Promise.resolve(e.call(c));i=(Array.isArray(t)?t:[]).map(e=>({id:String(e.id??e.ID??e.key??e.name??""),name:String(e.name??e.id??e.ID??e.key??""),description:e.description??e.desc??"",enabled:!!(e.enabled??e.active??e.on),tags:Array.isArray(e.tags)?e.tags:[]})).filter(e=>e.id),F(i,N.value),j(`${i.length} règle(s) chargée(s).`,"#9fe89f")}catch(e){console.warn("[MonModBC] listRules a échoué",e),j("Impossible de lister les règles.","#f2a3a3")}finally{P(!1)}}L.className="mmdbc-status",L.textContent="BCX: en attente...",B.appendChild(L),h.appendChild(B),function(e,t){let n=!1,o=0,a=0,r=0,i=0;t.addEventListener("mousedown",t=>{n=!0,o=t.clientX,a=t.clientY;const c=e.getBoundingClientRect();r=c.left,i=c.top,e.style.left=`${r}px`,e.style.top=`${i}px`,e.style.right="auto",e.style.bottom="auto",t.preventDefault()}),window.addEventListener("mousemove",t=>{if(!n)return;const c=t.clientX-o,d=t.clientY-a;e.style.left=`${r+c}px`,e.style.top=`${i+d}px`}),window.addEventListener("mouseup",()=>{n=!1})}(m,f),g.addEventListener("click",()=>{a=!1,A()}),r.addEventListener("click",()=>{a=!0,A()}),b.addEventListener("input",()=>l(t,b.value)),w.addEventListener("click",()=>{l(e,y.value),u("Règles sauvegardées")}),v.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(y.value),u("Copié dans le presse-papiers")}catch{u("Copie impossible (permissions)")}}),E.addEventListener("click",()=>{b.value=n,y.value=o,l(t,n),l(e,o),u("Rétabli")}),k.addEventListener("click",async()=>{await O()}),$.addEventListener("click",async()=>{await async function(){if(!c)return void j("BCX non détecté.","#f2a3a3");const e=C.value;if(e){P(!0);try{const t=c.importFromSub??c.import??c.pullFromSub;if("function"!=typeof t)throw new Error("Méthode importFromSub absente");await Promise.resolve(t.call(c,e)),j(`Import depuis « ${C.options[C.selectedIndex]?.textContent??e} » réussi.`,"#9fe89f"),await D()}catch(e){console.warn("[MonModBC] importFromSub a échoué",e),j("Échec de l’import (droits ?).","#f2a3a3")}finally{P(!1)}}else j("Choisis d’abord un sub.","#f2a3a3")}()}),N.addEventListener("input",()=>F(i,N.value.trim())),async function(){const{rule:e,presence:t}=function(){const e=window,t=e.bcx??e.BCX??e.game?.addons?.get?.("BCX");return t&&"function"==typeof t.getModApi?{rule:t.getModApi("rule-manager")??null,presence:t.getModApi("presence")??null}:{rule:null,presence:null}}();c=e,d=t,c?(j("BCX détecté. Chargement des règles...","#9fe89f"),await O(),await D()):j("BCX non détecté. Ouvre le jeu avec BCX chargé.","#f2a3a3")}(),window.addEventListener("keydown",e=>{!e.altKey||"g"!==e.key&&"G"!==e.key||(a=!a,A(),e.preventDefault())}),A(),console.log("[MonModBC] Panneau Règles BCX prêt.")}var f;f=()=>{if(document.body)m();else{const e=new MutationObserver(()=>{document.body&&(e.disconnect(),m())});e.observe(document.documentElement,{childList:!0,subtree:!0})}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f,{once:!0}):f()}()}();
